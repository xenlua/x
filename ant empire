-- Auto Farm Hub with WindUI Library
-- Auto Hit Resources & Auto Collect Orbs & Auto Convert

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local VirtualUser = game:GetService("VirtualUser")
local rs = game:GetService("ReplicatedStorage")
local runService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local lp = Players.LocalPlayer

-- Load WindUI
local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/XenonLoader/WindUI/refs/heads/main/dist/main.lua"))()
WindUI.TransparencyValue = 0.2
WindUI:SetTheme("Plant")

local ScriptVersion = "v1.5"

-- Detect if getconnections is available
local hasGetConnections = type(getconnections) == "function"

-- Settings (Fresh every load, no save)
local settings = {
    AutoHit = false,
    AutoCollect = false,
    AutoConvert = false,
    HitRange = 50,
    CheckBackpack = true,
    CollectFood = true,
    CollectItems = true,
    InstantCollect = true,
}

-- Auto Convert State
local isConverting = false
local savedPosition = nil


-- Helper Functions
local function GetBackpackDataFromUI()
    local success, result = pcall(function()
        local PlayerGui = lp:WaitForChild("PlayerGui")
        local Hud = PlayerGui:FindFirstChild("Hud")

        if not Hud then
            return nil
        end

        local StorageUI = Hud:FindFirstChild("Stats") and Hud.Stats:FindFirstChild("Storage")
        if not StorageUI then
            return nil
        end

        local currentText = StorageUI.Content.CurrentStorage.Text
        local maxText = StorageUI.Content.MaxStorage.Text

        local function parseNumber(text)
            text = text:gsub(",", "")
            text = text:gsub("^/", "")
            local num = tonumber(text:match("[%d%.]+"))
            if not num then return 0 end

            if text:find("B") then
                return num * 1000000000
            elseif text:find("M") then
                return num * 1000000
            elseif text:find("K") then
                return num * 1000
            else
                return num
            end
        end

        local current = parseNumber(currentText)
        local max = parseNumber(maxText)

        return {Storage = current, Capacity = max}
    end)
    return success and result or nil
end

local function GetOrbsController()
    local success, result = pcall(function()
        return require(rs.Modules.Framework).GetController("OrbsController")
    end)
    return success and result or nil
end

local function GetNestController()
    local success, result = pcall(function()
        return require(rs.Modules.Framework).GetController("NestController")
    end)
    return success and result or nil
end

local function FireProximityPrompt(proximityPrompt, holdTime)
    holdTime = holdTime or 0.5
    local success = false

    pcall(function()
        if fireproximityprompt then
            fireproximityprompt(proximityPrompt, holdTime)
            success = true
            return
        end
    end)

    if success then return true end

    if hasGetConnections then
        pcall(function()
            if proximityPrompt.PromptButtonHoldBegan then
                local connections = getconnections(proximityPrompt.PromptButtonHoldBegan)
                if connections and #connections > 0 then
                    connections[1]:Fire()
                    task.wait(holdTime)
                    if proximityPrompt.PromptButtonHoldEnded then
                        local endConnections = getconnections(proximityPrompt.PromptButtonHoldEnded)
                        if endConnections and #endConnections > 0 then
                            endConnections[1]:Fire()
                        end
                    end
                    success = true
                    return
                end
            end
        end)
    end

    if success then return true end

    pcall(function()
        if proximityPrompt.PromptTriggered then
            proximityPrompt.PromptTriggered:Fire()
            success = true
        end
    end)

    return success
end

local function TeleportToQueenAnt()
    local success, message = pcall(function()
        local NestController = GetNestController()
        if not NestController then
            return false, "NestController not found"
        end

        local nestFolder = NestController.NestFolder
        if not nestFolder then
            return false, "Nest not found! You need a nest first."
        end

        local queenPoint = nestFolder:WaitForChild("QueenPoint", 3)
        if not queenPoint then
            return false, "Queen Ant point not found!"
        end

        local char = lp.Character
        if not char then
            return false, "Character not found"
        end

        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then
            return false, "HumanoidRootPart not found"
        end

        savedPosition = hrp.CFrame
        hrp.CFrame = queenPoint.CFrame + Vector3.new(0, 3, 0)
        return true, "Teleported to Queen Ant!"
    end)

    return success, message
end

local function TriggerConvertWithLoop()
    local NestController = GetNestController()
    if not NestController then
        return false, "NestController not found"
    end

    local nestFolder = NestController.NestFolder
    if not nestFolder then
        return false, "Nest not found!"
    end

    local queenPoint = nestFolder:WaitForChild("QueenPoint", 5)
    if not queenPoint then
        return false, "Queen Ant point not found!"
    end

    local proximityPrompt = queenPoint:FindFirstChild("ProximityPrompt")
    if not proximityPrompt then
        return false, "ProximityPrompt not found!"
    end

    local backpackData = GetBackpackDataFromUI()
    if not backpackData or backpackData.Storage <= 0 then
        return false, "No food to convert!"
    end

    if not proximityPrompt.Enabled then
        return false, "Store Food is not available!"
    end

    if proximityPrompt.ActionText ~= "Store Food" then
        return false, "Action is not 'Store Food' - Current: " .. tostring(proximityPrompt.ActionText)
    end

    local maxLoopTime = 15
    local startTime = tick()
    local conversionStarted = false
    local loopCount = 0

    while tick() - startTime < maxLoopTime do
        loopCount = loopCount + 1
        FireProximityPrompt(proximityPrompt, 0.5)
        task.wait(0.2)

        local currentNestController = GetNestController()
        if currentNestController and currentNestController.IsConverting == true then
            conversionStarted = true
            break
        end

        local currentBackpackData = GetBackpackDataFromUI()
        if currentBackpackData and currentBackpackData.Storage < backpackData.Storage then
            conversionStarted = true
            break
        end
    end

    if conversionStarted then
        return true, string.format("✓ Started after %d attempts", loopCount)
    else
        return false, string.format("✗ Failed after %d attempts", loopCount)
    end
end

local function ReturnToSavedPosition()
    if not savedPosition then
        return false, "No saved position"
    end

    local success, message = pcall(function()
        local char = lp.Character
        if not char then
            return false, "Character not found"
        end

        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then
            return false, "HumanoidRootPart not found"
        end

        hrp.CFrame = savedPosition
        savedPosition = nil
        return true, "Returned to original position!"
    end)

    return success, message
end

local function AutoConvertCycle()
    if isConverting then
        pcall(function()
            WindUI:Notify({
                Title = "Auto Convert",
                Content = "Already converting! Please wait...",
                Duration = 3,
                Image = "info"
            })
        end)
        return
    end

    isConverting = true

    pcall(function()
        WindUI:Notify({
            Title = "Auto Convert",
            Content = "Starting conversion process...",
            Duration = 2,
            Image = "loader"
        })
    end)

    local backpackData = GetBackpackDataFromUI()
    if not backpackData or backpackData.Storage <= 0 then
        pcall(function()
            WindUI:Notify({
                Title = "Auto Convert",
                Content = "No food to convert!",
                Duration = 3,
                Image = "x"
            })
        end)
        isConverting = false
        return
    end

    local char = lp.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        pcall(function()
            WindUI:Notify({
                Title = "Auto Convert",
                Content = "Character not found!",
                Duration = 3,
                Image = "x"
            })
        end)
        isConverting = false
        return
    end

    savedPosition = char.HumanoidRootPart.CFrame

    local success, message = TeleportToQueenAnt()
    if not success then
        pcall(function()
            WindUI:Notify({
                Title = "Auto Convert",
                Content = message or "Failed to teleport!",
                Duration = 3,
                Image = "x"
            })
        end)
        isConverting = false
        return
    end

    task.wait(1.5)

    pcall(function()
        WindUI:Notify({
            Title = "Auto Convert",
            Content = "Triggering conversion (firing until started)...",
            Duration = 3,
            Image = "loader"
        })
    end)

    success, message = TriggerConvertWithLoop()
    if not success then
        pcall(function()
            WindUI:Notify({
                Title = "Auto Convert",
                Content = message or "Failed to trigger convert!",
                Duration = 3,
                Image = "x"
            })
        end)
        task.wait(0.5)
        if savedPosition then
            char.HumanoidRootPart.CFrame = savedPosition
        end
        isConverting = false
        return
    end

    pcall(function()
        WindUI:Notify({
            Title = "Auto Convert",
            Content = message or "Conversion started! Waiting for completion...",
            Duration = 3,
            Image = "loader"
        })
    end)

    local startTime = tick()
    local maxWaitTime = 120
    local conversionComplete = false
    local initialStorage = backpackData.Storage
    local checkInterval = 0
    local wasConverting = false
    local noFoodToConvert = false

    while tick() - startTime < maxWaitTime do
        task.wait(0.3)
        checkInterval = checkInterval + 0.3

        local currentBackpackData = GetBackpackDataFromUI()
        if currentBackpackData and currentBackpackData.Storage == 0 then
            noFoodToConvert = true
            break
        end

        local NestController = GetNestController()
        if NestController then
            if NestController.IsConverting == true then
                wasConverting = true
                if checkInterval >= 5 then
                    pcall(function()
                        WindUI:Notify({
                            Title = "Auto Convert",
                            Content = "Converting in progress...",
                            Duration = 2,
                            Image = "loader"
                        })
                    end)
                    checkInterval = 0
                end
            elseif NestController.IsConverting == false and wasConverting == true then
                task.wait(0.5)

                local newBackpackData = GetBackpackDataFromUI()
                if newBackpackData and newBackpackData.Storage < initialStorage then
                    conversionComplete = true
                    break
                else
                    if newBackpackData and newBackpackData.Storage == 0 then
                        noFoodToConvert = true
                        break
                    end
                    task.wait(1)
                end
            end
        end

        if checkInterval >= 15 and wasConverting then
            break
        end
    end

    if noFoodToConvert then
        pcall(function()
            WindUI:Notify({
                Title = "Auto Convert",
                Content = "All food converted! Returning to farm...",
                Duration = 3,
                Image = "check"
            })
        end)
    elseif conversionComplete then
        pcall(function()
            WindUI:Notify({
                Title = "Auto Convert",
                Content = "Conversion complete! Returning to farm...",
                Duration = 2,
                Image = "check"
            })
        end)
    else
        pcall(function()
            WindUI:Notify({
                Title = "Auto Convert",
                Content = "Conversion finished! Returning to farm...",
                Duration = 3,
                Image = "check"
            })
        end)
    end

    task.wait(0.5)
    if savedPosition and char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = savedPosition
        savedPosition = nil

        task.wait(0.5)
        pcall(function()
            WindUI:Notify({
                Title = "Auto Convert",
                Content = "Returned to farming position! Resuming farm...",
                Duration = 2,
                Image = "check"
            })
        end)
    end

    isConverting = false
    task.wait(1)
end

local function CollectOrb(orb)
    if not orb or not orb.Model or orb.Model.Parent == nil then return false end
    if orb.Type == "Food" and not settings.CollectFood then return false end
    if orb.Type == "Item" and not settings.CollectItems then return false end
    if not settings.InstantCollect and orb.SpawnElapsed < 1 then return false end

    local success = pcall(function()
        local OrbsController = GetOrbsController()
        if OrbsController and OrbsController.CollectOrb then
            OrbsController.CollectOrb(orb)
        end
    end)

    return success
end

-- Auto Hit Resources Loop
local autoHitRunning = false
local lastConvertAttempt = 0
local convertCooldown = 10

task.spawn(function()
    task.wait(2)
    autoHitRunning = true

    while true do
        task.wait(0.1)

        if not settings.AutoHit then continue end

        local char = lp.Character
        if not char then continue end

        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then continue end

        local fields = workspace:FindFirstChild("Fields")
        if not fields then continue end

        if settings.CheckBackpack then
            local backpackData = GetBackpackDataFromUI()

            if backpackData then
                local current = backpackData.Storage
                local capacity = backpackData.Capacity

                if current >= (capacity * 0.95) then
                    if settings.AutoConvert and not isConverting then
                        local currentTime = tick()
                        if currentTime - lastConvertAttempt >= convertCooldown then
                            lastConvertAttempt = currentTime

                            WindUI:Notify({
                                Title = "Auto Convert",
                                Content = "Backpack 95% full! Starting auto convert...",
                                Duration = 3,
                                Image = "alert-triangle"
                            })

                            task.spawn(AutoConvertCycle)
                        end
                    end
                    continue
                end

                if current >= capacity then
                    continue
                end
            end
        end

        local resourcesToHit = {}

        for _, field in pairs(fields:GetChildren()) do
            local resourcesFolder = field:FindFirstChild("Resources")
            if resourcesFolder then
                for _, res in pairs(resourcesFolder:GetChildren()) do
                    if res and res.Parent then
                        local root = res:FindFirstChild("Root")
                        if root then
                            local playerPos = hrp.Position
                            local resourcePos = root.Position
                            local distance = (playerPos - resourcePos).Magnitude

                            if distance <= settings.HitRange then
                                table.insert(resourcesToHit, res)
                            end
                        end
                    end
                end
            end
        end

        for _, res in ipairs(resourcesToHit) do
            pcall(function()
                rs.Remotes.Tool.Hit:FireServer(res)
            end)
        end

        if #resourcesToHit > 0 then
            task.wait(0.05)
        end
    end
end)

-- Auto Collect Orbs Loop
local lastCollectCheck = 0
runService.Heartbeat:Connect(function(deltaTime)
    if not settings.AutoCollect then return end

    lastCollectCheck = lastCollectCheck + deltaTime
    if lastCollectCheck < 0.1 then return end
    lastCollectCheck = 0

    local OrbsController = GetOrbsController()
    if not OrbsController then return end

    local activeOrbs = OrbsController.GetActiveOrbs and OrbsController.GetActiveOrbs()
    if not activeOrbs or type(activeOrbs) ~= "table" or #activeOrbs == 0 then return end

    local char = lp.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end

    for i = #activeOrbs, 1, -1 do
        local orb = activeOrbs[i]
        if orb and orb.Model and orb.Model.Parent then
            pcall(function()
                CollectOrb(orb)
            end)
        end
    end
end)

-- Anti AFK
lp.Idled:Connect(function()
    pcall(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new(0,0))
    end)
end)

-- Create WindUI Window
local Window = WindUI:CreateWindow({
    Title = 'Auto Farm Hub',
    Icon = "zap",
    Author = "Avantrix",
    Folder = "AutoFarmHub",
    Size = UDim2.fromOffset(580, 490),
    Theme = "Plant",
    HideSearchBar = false,
    SideBarWidth = 200,
    Acrylic = false,
})

Window:EditOpenButton({
    Title = "Open Auto Farm",
    Icon = "monitor",
    CornerRadius = UDim.new(0,16),
    StrokeThickness = 2,
    Color = ColorSequence.new(
        Color3.fromHex("FF0F7B"),
        Color3.fromHex("F89B29")
    ),
    OnlyMobile = false,
    Enabled = true,
    Draggable = true,
})

Window:DisableTopbarButtons({"Fullscreen"})

Window:Tag({
    Title = ScriptVersion,
    Color = Color3.fromHex("#30ff6a")
})

WindUI:Notify({
    Title = "Auto Farm Hub",
    Content = "Successfully loaded!",
    Duration = 5,
    Image = "square-check-big"
})

-- Create Sections and Tabs
local Sections = {
    Main = Window:Section({ Title = "Features", Opened = true }),
}

local Tabs = {
    Information = Sections.Main:Tab({
        Title = "Information",
        Icon = "info",
        Desc = "Information about the script"
    }),
    Main = Sections.Main:Tab({
        Title = "Main",
        Icon = "house",
        Desc = "Main features and settings"
    }),
}

-- INFORMATION TAB
Tabs.Information:Section({
    Title = "AUTO FARM HUB",
    TextSize = 18,
})

local BackpackParagraph = Tabs.Information:Paragraph({
    Title = "Backpack Status",
    Desc = "Loading backpack data...",
})

Tabs.Information:Paragraph({
    Title = "Executor Info",
    Desc = string.format('<font color="%s">%s • getconnections: %s</font>',
        hasGetConnections and "rgb(0,255,0)" or "rgb(255,165,0)",
        identifyexecutor and identifyexecutor() or "Unknown Executor",
        hasGetConnections and "✓" or "✗"
    ),
})

Tabs.Information:Paragraph({
    Title = "Features",
    Desc = [[<font color="rgb(255,255,255)">[+] Auto Hit Resources
[+] Auto Collect Orbs
[+] Auto Convert (Loop)
[+] Anti AFK
[+] Smart Backpack</font>]],
})

Tabs.Information:Code({
    Title = "Discord",
    Code = [[https://discord.gg/cF8YeDPt2G]],
    OnCopy = function()
        setclipboard("https://discord.gg/cF8YeDPt2G")
        WindUI:Notify({
            Title = "Copied!",
            Content = "Discord link copied to clipboard",
            Duration = 2
        })
    end
})

-- AUTO HIT SECTION
Tabs.Main:Section({
    Title = "Auto Hit Settings",
    TextSize = 18,
})

local AutoHitToggle = Tabs.Main:Toggle({
    Title = "Enable Auto Hit",
    Desc = "Automatically hit nearby resources",
    Value = false,
    Callback = function(value)
        settings.AutoHit = value
        WindUI:Notify({
            Title = "Auto Hit",
            Content = value and "Enabled ✓" or "Disabled ✗",
            Duration = 2,
            Image = value and "check" or "x"
        })
    end
})

local AutoConvertToggle = Tabs.Main:Toggle({
    Title = "Auto Convert",
    Desc = "Auto convert food when backpack is 95% full",
    Value = false,
    Callback = function(value)
        settings.AutoConvert = value
        if value then
            WindUI:Notify({
                Title = "Auto Convert",
                Content = "Enabled ✓ - Will auto convert at 95% backpack",
                Duration = 3,
                Image = "check"
            })
        else
            WindUI:Notify({
                Title = "Auto Convert",
                Content = "Disabled ✗",
                Duration = 2,
                Image = "x"
            })
        end
    end
})

-- AUTO COLLECT SECTION
Tabs.Main:Section({
    Title = "Auto Collect Settings",
    TextSize = 18,
})

local AutoCollectToggle = Tabs.Main:Toggle({
    Title = "Enable Auto Collect",
    Desc = "Automatically collect all orbs (unlimited range)",
    Value = false,
    Callback = function(value)
        settings.AutoCollect = value
        WindUI:Notify({
            Title = "Auto Collect",
            Content = value and "Enabled ✓" or "Disabled ✗",
            Duration = 2,
            Image = value and "check" or "x"
        })
    end
})

local CollectFoodToggle = Tabs.Main:Toggle({
    Title = "Collect Food Orbs",
    Desc = "Enable collecting food orbs",
    Value = true,
    Callback = function(value)
        settings.CollectFood = value
    end
})

local CollectItemsToggle = Tabs.Main:Toggle({
    Title = "Collect Item Orbs",
    Desc = "Enable collecting item orbs",
    Value = true,
    Callback = function(value)
        settings.CollectItems = value
    end
})

local InstantCollectToggle = Tabs.Main:Toggle({
    Title = "Instant Collect",
    Desc = "Collect orbs instantly (bypass 1s spawn delay)",
    Value = true,
    Callback = function(value)
        settings.InstantCollect = value
    end
})

-- TELEPORT SECTION
Tabs.Main:Section({
    Title = "Teleport & Convert",
    TextSize = 18,
})

local TeleportButton = Tabs.Main:Button({
    Title = "Teleport to Queen Ant",
    Desc = "Teleport to your nest's Queen Ant",
    Locked = false,
    Callback = function()
        local success, message = TeleportToQueenAnt()
        WindUI:Notify({
            Title = "Teleport to Queen Ant",
            Content = message or (success and "Teleported successfully!" or "Failed to teleport."),
            Duration = 3,
            Image = success and "square-check-big" or "square-x-big"
        })
    end
})

local ConvertButton = Tabs.Main:Button({
    Title = "Teleport & Auto Convert",
    Desc = "Teleport to Queen, convert food, and return",
    Locked = false,
    Callback = function()
        task.spawn(AutoConvertCycle)
    end
})

-- Set Toggle Key and Settings
Window:SetToggleKey(Enum.KeyCode.RightShift)
WindUI:SetNotificationLower(true)
Window:SelectTab(1)

-- Update Backpack Status in Real-time
task.spawn(function()
    task.wait(5)

    while true do
        task.wait(1)

        local success, err = pcall(function()
            local backpackData = GetBackpackDataFromUI()

            if not backpackData then
                BackpackParagraph:SetDesc("Waiting for game UI to load...")
                return
            end

            local current = backpackData.Storage
            local max = backpackData.Capacity

            if max == 0 then max = 1 end

            local percentage = math.floor((current / max) * 100)

            local color = "rgb(0,255,0)"
            if percentage >= 90 then
                color = "rgb(255,0,0)"
            elseif percentage >= 70 then
                color = "rgb(255,165,0)"
            elseif percentage >= 50 then
                color = "rgb(255,255,0)"
            end

            local function formatNumber(num)
                if num >= 1000000000 then
                    return string.format("%.2fB", num / 1000000000)
                elseif num >= 1000000 then
                    return string.format("%.2fM", num / 1000000)
                elseif num >= 1000 then
                    return string.format("%.2fK", num / 1000)
                else
                    return tostring(math.floor(num))
                end
            end

            local statusText = string.format(
                '<font color="%s">Current: %s / %s (%d%%)</font>\n' ..
                '<font color="rgb(200,200,200)">Available Space: %s</font>\n' ..
                '<font color="rgb(150,150,150)">Status: %s</font>',
                color,
                formatNumber(current),
                formatNumber(max),
                percentage,
                formatNumber(max - current),
                percentage >= 100 and "FULL!" or (percentage >= 90 and "Almost Full" or (percentage >= 70 and "High" or (percentage >= 50 and "Medium" or "Low")))
            )

            if BackpackParagraph then
                BackpackParagraph:SetDesc(statusText)
            end
        end)

        if not success then
            pcall(function()
                BackpackParagraph:SetDesc('<font color="rgb(255,100,100)">Error: ' .. tostring(err) .. '</font>')
            end)
        end
    end
end)
